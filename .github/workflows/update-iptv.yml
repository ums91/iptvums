name: Auto Update IPTV Playlist

on:
  schedule:
    # Runs every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update playlist (manual section preserved, no duplication)
        run: |
          set -e

          PLAYLIST="playlists/all-channels.m3u"

          MANUAL_START="# === MANUAL CHANNELS (PRESERVED) START ==="
          MANUAL_END="# === MANUAL CHANNELS (PRESERVED) END ==="
          AUTO_MARKER="# === AUTO-GENERATED CHANNELS (DO NOT EDIT BELOW) ==="

          TMP_MANUAL="manual.m3u"
          TMP_AUTO="auto.m3u"

          mkdir -p playlists

          # Create base playlist if missing (YAML-safe)
          if [ ! -f "$PLAYLIST" ]; then
            printf "#EXTM3U\n\n%s\n%s\n\n%s\n" \
              "$MANUAL_START" \
              "$MANUAL_END" \
              "$AUTO_MARKER" \
              > "$PLAYLIST"
          fi

          # Extract manual section EXACTLY ONCE
          awk -v start="$MANUAL_START" -v end="$MANUAL_END" '
            $0 == start { keep=1 }
            keep { print }
            $0 == end { keep=0 }
          ' "$PLAYLIST" > "$TMP_MANUAL"

          # Download fresh auto playlist (strip duplicate EXTM3U)
          curl -L https://iptv-org.github.io/iptv/index.m3u \
          | awk 'NR==1 || $0 !~ /^#EXTM3U/' \
          > "$TMP_AUTO"

          # Rebuild playlist cleanly (no duplication possible)
          {
            printf "#EXTM3U\n\n"
            cat "$TMP_MANUAL"
            printf "\n\n%s\n\n" "$AUTO_MARKER"
            cat "$TMP_AUTO"
          } > "$PLAYLIST"

          rm -f "$TMP_MANUAL" "$TMP_AUTO"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add playlists/all-channels.m3u
          git commit -m "Auto-update IPTV playlist (manual section preserved)" || exit 0

          git pull --rebase origin main
          git push origin main
