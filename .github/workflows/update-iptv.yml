name: Auto Update IPTV Playlist

on:
  schedule:
    # Runs every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update playlist (preserve manual section)
        run: |
          set -e

          PLAYLIST="playlists/all-channels.m3u"
          TMP_AUTO="auto.m3u"

          # Ensure playlist exists
          if [ ! -f "$PLAYLIST" ]; then
            echo "#EXTM3U" > "$PLAYLIST"
            echo "# === MANUAL CHANNELS (PRESERVED) START ===" >> "$PLAYLIST"
            echo "# === MANUAL CHANNELS (PRESERVED) END ===" >> "$PLAYLIST"
            echo "# === AUTO-GENERATED CHANNELS (DO NOT EDIT BELOW) ===" >> "$PLAYLIST"
          fi

          # Extract preserved (manual) section
          awk '
            BEGIN { keep=1 }
            /^# === AUTO-GENERATED CHANNELS/ { keep=0 }
            keep { print }
          ' "$PLAYLIST" > preserved.m3u

          # Download fresh auto playlist (single EXTM3U)
          curl -L https://iptv-org.github.io/iptv/index.m3u \
          | awk 'NR==1 || $0 !~ /^#EXTM3U/' \
          > "$TMP_AUTO"

          # Rebuild final playlist
          cat preserved.m3u > "$PLAYLIST"
          echo "" >> "$PLAYLIST"
          cat "$TMP_AUTO" >> "$PLAYLIST"

          rm -f preserved.m3u "$TMP_AUTO"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add playlists/all-channels.m3u
          git commit -m "Auto-update IPTV playlist (preserving manual channels)" || exit 0
          git push
