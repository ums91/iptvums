name: Auto Update IPTV Playlist

on:
  schedule:
    # Runs every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update playlist (manual section preserved, no duplication)
        run: |
          set -e

          PLAYLIST="playlists/all-channels.m3u"
          AUTO_MARKER="# === AUTO-GENERATED CHANNELS (DO NOT EDIT BELOW) ==="

          TMP_MANUAL="manual.m3u"
          TMP_AUTO="auto.m3u"

          # Ensure base playlist exists
          if [ ! -f "$PLAYLIST" ]; then
            mkdir -p playlists
            cat <<EOF > "$PLAYLIST"
#EXTM3U

# === MANUAL CHANNELS (PRESERVED) START ===
# === MANUAL CHANNELS (PRESERVED) END ===

$AUTO_MARKER
EOF
          fi

          # Extract ONLY the manual section (once)
          awk '
            BEGIN { keep=0 }
            /^# === MANUAL CHANNELS \(PRESERVED\) START ===/ { keep=1 }
            keep { print }
            /^# === MANUAL CHANNELS \(PRESERVED\) END ===/ { keep=0 }
          ' "$PLAYLIST" > "$TMP_MANUAL"

          # Download fresh auto playlist (strip duplicate EXTM3U)
          curl -L https://iptv-org.github.io/iptv/index.m3u \
          | awk 'NR==1 || $0 !~ /^#EXTM3U/' \
          > "$TMP_AUTO"

          # Rebuild playlist from scratch (NO duplication possible)
          {
            echo "#EXTM3U"
            echo ""
            cat "$TMP_MANUAL"
            echo ""
            echo "$AUTO_MARKER"
            echo ""
            cat "$TMP_AUTO"
          } > "$PLAYLIST"

          rm -f "$TMP_MANUAL" "$TMP_AUTO"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add playlists/all-channels.m3u
          git commit -m "Auto-update IPTV playlist (manual section preserved)" || exit 0

          git pull --rebase origin main
          git push origin main
