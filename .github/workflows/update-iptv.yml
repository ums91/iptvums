name: Auto Update IPTV Playlist

on:
  schedule:
    # Runs every 3 days at 03:00 UTC
    - cron: "0 3 */3 * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update playlist (replace everything after AUTO-GENERATED marker)
        run: |
          set -e

          PLAYLIST="playlists/all-channels.m3u"
          MARKER="# === AUTO-GENERATED CHANNELS (DO NOT EDIT BELOW) ==="
          TMP_AUTO="auto.m3u"
          TMP_KEEP="keep.m3u"

          # Ensure playlist exists
          if [ ! -f "$PLAYLIST" ]; then
            echo "#EXTM3U" > "$PLAYLIST"
            echo "" >> "$PLAYLIST"
            echo "# === MANUAL CHANNELS (PRESERVED) START ===" >> "$PLAYLIST"
            echo "# === MANUAL CHANNELS (PRESERVED) END ===" >> "$PLAYLIST"
            echo "" >> "$PLAYLIST"
            echo "$MARKER" >> "$PLAYLIST"
          fi

          # Keep everything up to and including the marker
          awk -v marker="$MARKER" '
            { print }
            $0 == marker { exit }
          ' "$PLAYLIST" > "$TMP_KEEP"

          # Download fresh playlist, remove duplicate EXTM3U
          curl -L https://iptv-org.github.io/iptv/index.m3u \
          | awk 'NR==1 || $0 !~ /^#EXTM3U/' \
          > "$TMP_AUTO"

          # Rebuild playlist
          cat "$TMP_KEEP" > "$PLAYLIST"
          echo "" >> "$PLAYLIST"
          cat "$TMP_AUTO" >> "$PLAYLIST"

          rm -f "$TMP_KEEP" "$TMP_AUTO"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add playlists/all-channels.m3u
          git commit -m "Auto-update IPTV playlist (replace after marker)" || exit 0

          git pull --rebase origin main
          git push origin main
